<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>길드 분배 · 교환/택배 수수료 계산기</title>
<style>
  :root { --card-bg: rgba(255,255,255,0.86); --muted:#666; --accent:#0a7cff; --radius:16px; }
  html, body { margin:0; padding:0; height:100%; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Apple SD Gothic Neo,"Noto Sans KR",Arial; background:#0b1220; color:#0b1220; }
  /* 배경: 살짝 흐릿/어둡게 */
  body::before{
    content:""; position:fixed; inset:0;
    background:url("./musicbg.jpg") center/cover no-repeat;
    filter:blur(4px) brightness(0.28); transform:scale(1.03); z-index:-1;
  }
  .wrap{max-width:1100px; margin:24px auto; padding:16px;}
  .card{background:var(--card-bg); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.18); padding:18px; margin-bottom:14px; backdrop-filter:blur(6px);}
  .title{color:#fff; font-weight:800; font-size:24px; letter-spacing:.2px; margin:10px 0 16px 6px;}
  .grid{display:grid; gap:12px; grid-template-columns:repeat(12,1fr);}
  .grid>*{grid-column:span 12;}
  @media (min-width:860px){ .grid.cols-2>*{grid-column: span 6} .grid.cols-3>*{grid-column: span 4} }
  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
  input,textarea,select,button{width:100%; padding:10px 12px; border-radius:12px; border:1px solid #dcdfe6; background:#fff; font-size:14px; outline:none;}
  input:focus,textarea:focus,select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(10,124,255,.12);}
  button{background:var(--accent); color:#fff; font-weight:700; border:none; cursor:pointer;}
  button.secondary{background:#111827;}
  button.ghost{background:#fff; color:#111; border:1px solid #dcdfe6;}
  .row{display:flex; gap:10px; flex-wrap:wrap;} .row>*{flex:1 1 200px;}
  .muted{color:var(--muted); font-size:13px;}
  table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px;}
  thead th{background:#0a7cff; color:#fff; text-align:right; padding:12px 10px; font-weight:700; white-space:nowrap;}
  thead th:first-child{ text-align:left; }
  tbody td{border-bottom:1px solid #eef2f7; padding:10px; text-align:right;}
  tbody td:first-child{ text-align:left; font-weight:700;}
  tfoot td{background:#f6f9fe; font-weight:700; padding:10px; text-align:right;}
  .right{text-align:right;}
  .section-title{font-weight:800; margin:8px 0 12px;}
  .hr{height:1px; background:#e9edf4; margin:12px 0;}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">길드 분배 · 교환/택배 수수료 계산기</div>

    <!-- 설정 -->
    <div class="card">
      <div class="grid cols-3">
        <div>
          <label>총 분배 금액 (메소 또는 원)</label>
          <input id="totalAmount" type="number" min="0" step="1" placeholder="예: 120000000" value="120000000" />
          <div class="muted">예: 전리품 판매 총액</div>
        </div>
        <div>
          <label>참가자 (쉼표/줄바꿈 — <b>이름</b> 또는 <b>이름:비율%</b>)</label>
          <textarea id="participants" rows="4" placeholder="예: A:10%, B, C">A:50, B:30, C:20</textarea>
          <div class="muted">비율을 쓴 항목은 고정, 나머지는 <b>남은 퍼센트</b>를 <b>동일 분배</b>합니다.</div>
        </div>
        <div>
          <label>보기 모드</label>
          <select id="mode">
            <option value="all">모두 보기</option>
            <option value="exchange">교환(직거래)</option>
            <option value="parcel_normal">택배 — 일반</option>
            <option value="parcel_express">택배 — 특급</option>
          </select>
          <div class="muted">요율표는 시스템 고정값을 사용합니다. (10만 미만 0%)</div>
        </div>
      </div>

      <div class="grid cols-2">
        <div>
          <label>택배 배송비 (일반 / 특급)</label>
          <div class="row">
            <input id="parcelShipNormal" type="number" min="0" step="1" value="5000" />
            <input id="parcelShipExpress" type="number" min="0" step="1" value="20000" />
          </div>
          <div class="muted">배송비는 수수료와 별개이며 <b>항상 배송 인원 수만큼</b> 발생합니다.</div>
        </div>
        <div>
          <label>택배 분배 방식</label>
          <select id="parcelSplitMode">
            <option value="ratio">비율 분배(기존 방식)</option>
            <option value="equal_all_in">N분의1 (수수료·배송비 포함)</option>
          </select>
          <div class="muted">N분의1: 모든 수수료·배송비를 고려해 균등 수령액을 역산합니다.</div>
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:8px">
        <div>
          <label>배송 시 본인 제외</label>
          <div class="row">
            <select id="excludeSelf">
              <option value="no">아니오 (모두에게 보냄)</option>
              <option value="yes">예 (본인 제외)</option>
            </select>
          </div>
          <div class="muted">비율 분배 모드에서는 <b>참가자 목록의 첫 번째를 본인으로 간주</b>해 그 사람에게는 택배 수수료/배송비를 적용하지 않습니다.</div>
        </div>
        <div style="display:flex; align-items:end; gap:10px">
          <button onclick="compute()">계산하기</button>
          <button class="ghost" onclick="fillDemo()">데모 채우기</button>
        </div>
      </div>
    </div>

    <!-- 결과 -->
    <div class="card" id="resultCard" style="display:none">
      <div class="section-title">분배 결과표</div>
      <div class="muted">교환은 수신자 부담 수수료, 택배는 선택한 분배 방식과 “본인 제외” 규칙을 적용합니다.</div>
      <div class="hr"></div>
      <div style="overflow:auto">
        <table id="resultTable">
          <thead></thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="6" id="senderCostRow" class="right">-</td></tr></tfoot>
        </table>
      </div>
    </div>
  </div>

<script>
  const fmt = n => n.toLocaleString('ko-KR');

  /* 고정 요율표(스크린샷) — 10만 미만 0% */
  const COURIER_RATE_TIERS = [ // 택배(발신자 부담 비용 산정용)
    { min: 100000, rate: 0.012 },
    { min: 1000000, rate: 0.027 },
    { min: 5000000, rate: 0.040 },
    { min: 10000000, rate: 0.050 },
    { min: 25000000, rate: 0.060 },
    { min: 100000000, rate: 0.070 },
  ];
  const EXCHANGE_RATE_TIERS = [ // 교환(수신자 차감)
    { min: 100000, rate: 0.008 },
    { min: 1000000, rate: 0.018 },
    { min: 5000000, rate: 0.030 },
    { min: 10000000, rate: 0.040 },
    { min: 25000000, rate: 0.050 },
    { min: 100000000, rate: 0.060 },
  ];
  function getRate(amount, tiers){
    let r = 0; // 10만 미만 0%
    for (const t of tiers) if (amount >= t.min) r = t.rate;
    return r;
  }

  // 참가자: "이름"만 있으면 남은 퍼센트를 동일분배, "이름:10%"는 고정
  function parseParticipantsSmart(text){
    const tokens = text.split(/[,\\n]/).map(s=>s.trim()).filter(Boolean);
    const explicit=[], implicit=[];
    for (const t of tokens){
      if (t.includes(':')){
        const [nameRaw, pctRaw] = t.split(':');
        const name=(nameRaw||'').trim();
        const pct=parseFloat((pctRaw||'').replace('%','').trim());
        if (name && !isNaN(pct)) explicit.push({name, pct});
      } else implicit.push({name:t});
    }
    const sumExp=explicit.reduce((s,x)=>s+x.pct,0);
    const remain=Math.max(0, 100-sumExp);
    const each=implicit.length? remain/implicit.length : 0;
    return [...explicit, ...implicit.map(x=>({name:x.name, pct:each}))];
  }

  function buildHeader(mode){
    const thead=document.querySelector('#resultTable thead');
    thead.innerHTML='';
    const tr=document.createElement('tr');
    ['참가자','비율','배정액'].forEach((name,i)=>{
      const th=document.createElement('th'); th.textContent=name; if(i===0) th.style.textAlign='left'; tr.appendChild(th);
    });
    const modeCols = {
      exchange:['교환(직거래) 수령'],
      parcel_normal:['택배 일반 수령'],
      parcel_express:['택배 특급 수령'],
      all:['교환(직거래) 수령','택배 일반 수령','택배 특급 수령']
    }[mode];
    modeCols.forEach(name=>{ const th=document.createElement('th'); th.textContent=name; tr.appendChild(th); });
    thead.appendChild(tr);
  }

  // N분의1(수수료·배송비 포함)에서 균등 수령액 A를 구함
  // m = 배송 대상 인원수 (excludeSelf면 n-1, 아니면 n)
  function solveEqualAfterAllCosts(total, n, shipPerSend, tiers, m){
    if (n<=0) return 0;
    const frac = (m / n);                    // 전체 평균에 반영되는 비율
    const B = total / n - shipPerSend * frac; // 1인당 (수령액 + 평균수수료)에 쓸 예산
    if (B <= 0) return 0;

    // 고정점 반복: A = B / (1 + frac * rate(A))
    let A = B;
    for (let i=0;i<12;i++){
      const r = getRate(A, tiers);
      const nextA = B / (1 + frac * r);
      if (Math.abs(nextA - A) < 1) { A = Math.floor(nextA); break; }
      A = nextA;
    }
    const rFinal = getRate(A, tiers);
    return Math.max(0, Math.floor(B / (1 + frac * rFinal)));
  }

  function compute(){
    const total = Math.floor(Number(document.getElementById('totalAmount').value)||0);
    const parts = parseParticipantsSmart(document.getElementById('participants').value);
    const mode  = document.getElementById('mode').value;
    const shipN = Math.floor(Number(document.getElementById('parcelShipNormal').value)||0);
    const shipE = Math.floor(Number(document.getElementById('parcelShipExpress').value)||0);
    const parcelSplitMode = document.getElementById('parcelSplitMode').value;
    const excludeSelf = document.getElementById('excludeSelf').value === 'yes';

    if (!total || !parts.length){ alert('총 금액과 참가자를 확인하세요.'); return; }

    buildHeader(mode);
    const tbody=document.querySelector('#resultTable tbody');
    tbody.innerHTML='';

    const rows = parts.map(p => ({ name:p.name, pct:p.pct, base: Math.floor(total * (p.pct/100)) }));
    const n = rows.length;
    const m = Math.max(0, n - (excludeSelf ? 1 : 0)); // 배송 대상 인원수

    // 교환(직거래): 수신자 차감
    rows.forEach(r=>{
      const rate = getRate(r.base, EXCHANGE_RATE_TIERS);
      const fee  = Math.floor(r.base * rate);
      r.netExchange = Math.max(0, r.base - fee);
    });

    // 택배
    let senderCourierFeeN=0, senderCourierFeeE=0, senderCostN=0, senderCostE=0;

    if (parcelSplitMode === 'ratio') {
      // 비율 분배: 본인 제외가 켜지면 첫 번째 참가자는 발송 대상에서 제외
      const startIdx = excludeSelf ? 1 : 0;
      for (let i=0;i<rows.length;i++){
        const r = rows[i];
        if (i >= startIdx) { // 발송 대상
          const rate = getRate(r.base, COURIER_RATE_TIERS);
          const fee  = Math.floor(r.base * rate);
          senderCourierFeeN += fee;
          senderCourierFeeE += fee;
        }
        r.netParcelNormal = r.base;
        r.netParcelExpress = r.base;
      }
      senderCostN = senderCourierFeeN + shipN * m;
      senderCostE = senderCourierFeeE + shipE * m;

    } else {
      // N분의1(수수료·배송비 포함): 균등 수령액 역산, 본인 제외 반영(m 사용)
      const A_normal  = solveEqualAfterAllCosts(total, n, shipN, COURIER_RATE_TIERS, m);
      const A_express = solveEqualAfterAllCosts(total, n, shipE, COURIER_RATE_TIERS, m);

      rows.forEach(r=>{
        r.netParcelNormal  = A_normal;
        r.netParcelExpress = A_express;
      });

      // 총 발신자 비용 = (수수료×배송대상) + (배송비×배송대상)
      const rN = getRate(A_normal, COURIER_RATE_TIERS);
      const rE = getRate(A_express, COURIER_RATE_TIERS);
      senderCourierFeeN = Math.floor(A_normal * rN) * m;
      senderCourierFeeE = Math.floor(A_express * rE) * m;
      senderCostN = senderCourierFeeN + shipN * m;
      senderCostE = senderCourierFeeE + shipE * m;
    }

    // 렌더
    for (const r of rows){
      const tr=document.createElement('tr');
      const baseCells=[r.name, `${r.pct.toFixed(2)}%`, fmt(r.base)];
      let modeVals=[];
      if (mode==='exchange') modeVals=[fmt(r.netExchange)];
      else if (mode==='parcel_normal') modeVals=[fmt(r.netParcelNormal)];
      else if (mode==='parcel_express') modeVals=[fmt(r.netParcelExpress)];
      else modeVals=[fmt(r.netExchange), fmt(r.netParcelNormal), fmt(r.netParcelExpress)];
      [...baseCells, ...modeVals].forEach((val,i)=>{ const td=document.createElement('td'); td.textContent=val; if(i===0) td.style.textAlign='left'; tr.appendChild(td); });
      tbody.appendChild(tr);
    }

    const senderLine = (mode==='parcel_normal')
      ? `발신자 총비용(일반): 수수료 ${fmt(senderCourierFeeN)} + 배송비 ${fmt(shipN*m)} = ${fmt(senderCostN)}`
      : (mode==='parcel_express')
        ? `발신자 총비용(특급): 수수료 ${fmt(senderCourierFeeE)} + 배송비 ${fmt(shipE*m)} = ${fmt(senderCostE)}`
        : `발신자 총비용: 일반 ${fmt(senderCostN)} (수수료 ${fmt(senderCourierFeeN)} + 배송비 ${fmt(shipN*m)}) | 특급 ${fmt(senderCostE)} (수수료 ${fmt(senderCourierFeeE)} + 배송비 ${fmt(shipE*m)})`;
    document.getElementById('senderCostRow').textContent = senderLine;

    document.getElementById('resultCard').style.display='block';
  }

  function fillDemo(){
    document.getElementById('totalAmount').value = 120000000;
    document.getElementById('participants').value = "본인:25, 동료1:25, 동료2:25, 동료3:25";
    document.getElementById('parcelShipNormal').value = 5000;
    document.getElementById('parcelShipExpress').value = 20000;
    document.getElementById('mode').value = "all";
    document.getElementById('parcelSplitMode').value = "equal_all_in";
    document.getElementById('excludeSelf').value = "yes";
  }
</script>
</body>
</html>
